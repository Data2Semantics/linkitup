{% extends "dashboard.html" %}



{% block scripts %}


<script>
	$.ajaxSetup ({  
	    cache: false,
	    beforeSend: function(xhr){
			xhr.withCredentials = true;
		},
		xhrFields: { withCredentials: true },
		crossDomain: true
	});

	$(document).ready(function() { 
		$.localStorage('ready', false);
		$.localStorage('selected', {});
		$.localStorage('results', {});
		
		// Get the list of plugins, and render the plugin menu.
		$.get("{{ url_for('load_plugins') }}", function(data) {
			$.localStorage ( 'plugins', data.result);
			
			render_plugins(data.result);
		});

		$.get("{{ url_for('load_articles') }}", function(data){
			// Store the list of article_id/title pairs in local storage
			$.localStorage( 'articles', data.articles );
			// Store the dictionaries of all article details in local storage
			$.localStorage( 'details', data.details );
			
			// Render the list of articles
			render_articles(data.articles);
			
			// Render the details of the first article, and set the 'current' flag to that article_id
			if (data.articles.length > 0) {
				var article_id = data.articles[0].id;
				
				$.localStorage( 'current', article_id );
				
				render_article_details();
			} else {
				$("#article_details").html("Warning: no published or private articles found in your figshare account!")
			}
			
			$.localStorage('ready', true);
		});
		

		
	});

	function render_articles(articles) {
		$("#articles").select2({ 
			placeholder: "Start typing..." , 
			allowClear: true,
			data: articles 
		}); 
	}
	
	function render_article_details() {
		$('#article_details').html('Loading...');
		
		var url = "{{ url_for('article_details')}}";
		
		var callback = function(html) {
			$('#article_details').html(html);
		};
		
		post_article_html(url, callback);
	}
	
	function post_article_html(url, callback){
		var details = get_details();
		var payload = JSON.stringify(details);
			
		$.ajax({
			type: "POST",
			contentType: "application/json; charset=utf-8",
			url: url,
			data: payload,
			dataType: "html",
		}).success(callback);
	}
	
	function post_article_json(url, callback){
		var details = get_details();
		var payload = JSON.stringify(details);
		
		$.ajax({
			type: "POST",
			contentType: "application/json; charset=utf-8",
			url: url,
			data: payload,
			dataType: "json",
		}).success(callback);
	}

	function render_plugins(plugins){
		$.each(plugins, function(index, value){
			var plugin_link = $('<a id="'+ value.slug +'">'+value.name+'</a>');
			var li = $('<li></li>');
			li.append(plugin_link);
			$('#plugins_header').after(li);
			
			plugin_link.on('click',function(e){
				console.log(value.name + " clicked");
				run_plugin(value.slug, value.name, value.type);
			});
		});	
	}
	
	function run_plugin(plugin, name, type){
		var ready = $.localStorage('ready');
		
		if (ready) {
			var article_id = $.localStorage('current');
			
			/// Check whether the results are already in!
			
			var results = get_results(plugin);
			if (results != null && type == 'json') {
				render_plugin_results(plugin, results);
				$('#plugin_modal').modal('show');
			} else {
				var loading = "<div class='progress progress-striped active'>" +
					"<div class='bar' style='width: 100%;'>Loading links from " + 
					name 
					+ "...</div> " +
					"</div>";
			
				$('#plugin_modal_name').html(name);
				$('#plugin_modal_body').html(loading);
				$('#plugin_modal').modal('show');
			
				var url = "/" + plugin ;
			
				if (type == 'json') {
					var callback = function(data){
						
						if (data.urls != null){
							add_results(plugin, data.urls);
						
							render_plugin_results(plugin, data.urls);
							$('#'+plugin).toggleClass('active');
						} else {
							$('#plugin_modal_body').html('No results...');
						}
					};
			
					post_article_json(url, callback);
				} else if (type == 'html') {
					var callback = function(html){
						$('#plugin_modal_body').html(html);
						$('#'+plugin).toggleClass('active');
					};
				
					post_article_html(url, callback);
				} else {
					alert('Plugin has unknown type!');
				}
			}
			
		}
		
	}
	/*
	{% for r in results %}
		{% if r.urls %}
		{% for u in r.urls %}
			<label class='checkbox alert alert-warning' id='{{ u.short }}_label'>
					<input type='checkbox' name='url' web='{{ u.web }}' show='{{ u.show }}' value='{{ u.uri }}' id='{{ u.short }}_checkbox'>
					<a target="_new" href="{{ u.uri }}"><i class="icon-globe"></i></a>&nbsp;<a target="_new" href='{{ u.web }}'>{{ u.show }}</a> 
					{% if u.extra %}
					({{ u.extra }})
					{% endif %}
					{% if u.subscript %}
					<div><small>{{ u.subscript }}</small></div>
					{% endif %}
			</label>
			{% if u.description %}
				<div style="margin-top: -1em; margin-bottom: 1em;">
					<small>
						{{ u.description }} ...
					</small>
				</div>
			{% endif %}
					$("#{{ u.short }}_checkbox").click(function(){  
						$(this).parent().toggleClass('alert-warning');
					        $(this).parent().toggleClass('alert-success');
					    });

		{% endfor %}
		{% else %}
			<p>No links found to {{ r.title }}</p>
		{% endif %}
{% endfor %}

	*/
	function render_plugin_results(plugin, urls) {
		var body = $('#plugin_modal_body');
		console.log(urls);
		body.empty();
		

		
		$.each(urls, function(uindex, url) {
			var label = $('<label></label>');
			label.addClass('checkbox');
			label.addClass('alert');
			
			var input = $('<input type="checkbox"></input>');
			label.append(input);
			
			var selected = get_selected();
			if (url.uri in selected) {
				label.addClass('alert-success');
				input.attr('checked',true);
			} else {
				label.addClass('alert-warning');
			}
			
			input.on('click', function(){
				label.toggleClass('alert-warning');
				label.toggleClass('alert-success');
				
				if (input.is(':checked')) {

					add_selected(url.uri, url);

				} else {

					remove_selected(url.uri);

				}
				
				console.log(get_selected());
			});
			
			
			var uri = $('<a href="' + url.uri + '"><i class="icon-globe"></i></a>');
			label.append(uri);
			
			var web = $('<a href="' + url.web + '">' + url.show + '</a>');
			label.append(web);
			
			if (url.extra != null){ 
				var extra = $('<span/>').text('('+ url.extra + ')');
				label.append(extra);
			}
			
			if (url.subscript != null) {
				var subscript = $('<div><small>' + url.subscript + '</small></div>');
				label.append(subscript);
			}
			
			body.append(label);
			
			if (url.description != null) {
				var description_div = $('<div style="margin-top: -1em; margin-bottom: 1em;"></div>');
				var description = $('<small>' + url.description + '</small>');
				description_div.append(description);
				
				body.append(description_div);
			}
		});
	}
	
	function get_details(){
		var article_id = $.localStorage('current');
		
		return $.localStorage('details')[article_id];		
	}
	
	function get_selected(){
		return $.localStorage('selected');
	}
	
	function add_selected(key, value){
		var selected = $.localStorage('selected');
		
		selected[key] = value;
		
		$.localStorage('selected', selected);
	}
	
	function remove_selected(key){
		var selected = $.localStorage('selected');
		
		delete selected[key]
		
		$.localStorage('selected', selected);
	}
	
	function get_results(plugin) {
		var results = $.localStorage('results');
		
		if (plugin in results) {
			return results[plugin];
		} else {
			return null;
		}
	}
	
	function add_results(plugin, urls){
		var results = $.localStorage('results');
		
		results[plugin] = urls;
		
		$.localStorage('results', results);
	}
	

</script>
{% endblock scripts %}


{% block tabs %}
	<label for="articles"><i class="icon-search"></i> Select an article</label>
	<input type='hidden' id="articles" style="width: 100%; "></input>
{% endblock %}


{% block articles %}
	<div class="details" style="display: block" id="article_pane">
		<div id="article_details">
			<!-- this is where we'll output the HTML generated by calling the /details/<article_id> view -->
		</div>
	</div>
	
	<div class="modal hide fade" id="plugin_modal" tabindex="-1" role="dialog" aria-hidden="true">
	  <div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	    <h3 id="plugin_modal_name"></h3>
	  </div>
	  <div id="plugin_modal_body" class="modal-body"></div>
	  <div class="modal-footer">
	    <button id="plugin_modal_close" class="btn" data-dismiss="modal" aria-hidden="true">Save &amp; Close</button>
	  </div>
	</div>
{% endblock %}

{% block plugins %}
	<div class="plugins">
		<div class="well" style="padding: 8px 0;">
			<ul class="nav nav-list">
				<li class="nav-header" id="plugins_header">Plugins</li>
				<!-- this is where we'll output the list of plugins that can be ran against the currently selected article -->
				<li class="nav-header" id="actions_header">Actions</li>
				<li><a id="show">Preview Selection</a></li>
				<li><a id="rdf">Preview Nanopublication</a></li>
				<li><a id="add_to_figshare">Add to Figshare</a></li>
			</ul>
		</div>
		<div class="pull-right">
			<a id="refresh" style="cursor: pointer;" title="refresh article details"><i class="icon-refresh"></i></a>
			<a id="uncheck_all" style="cursor: pointer;"  title="uncheck all selected links"><i class="icon-remove"></i></a>
			<a href="{{ url_for('clear_session_data') }}" title="clear session data"><i class="icon-fire"></i></a>
		</div>
	</div>
{% endblock %}



